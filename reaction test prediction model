import gspread
from oauth2client.service_account import ServiceAccountCredentials
import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split
from sklearn.preprocessing import OneHotEncoder, StandardScaler
from sklearn.compose import ColumnTransformer
from sklearn.pipeline import Pipeline
from sklearn.svm import SVR


#Connect to Google Sheets using service account
scope = ["https://spreadsheets.google.com/feeds",
         "https://www.googleapis.com/auth/drive"]

creds = ServiceAccountCredentials.from_json_keyfile_name("service_account.json", scope)
client = gspread.authorize(creds)

spreadsheet = client.open("CS3237_Health_Assessment_Data")
sheet = spreadsheet.worksheet("Reaction Time Test")

data = sheet.get_all_records()
df = pd.DataFrame(data)

# Ensure required columns exist
required_columns = ["participant_gender", "reaction_time_ms", "actual_age"]
assert all(col in df.columns for col in required_columns), "Missing required columns."


#Clean Data Types

# Convert reaction_time_ms to float
df["reaction_time_ms"] = (
    df["reaction_time_ms"]
    .astype(str)
    .str.replace(",", "", regex=False)
    .replace("", np.nan)
    .astype(float)
)

# Convert actual_age to int
df["actual_age"] = (
    df["actual_age"]
    .astype(str)
    .str.replace(",", "", regex=False)
    .replace("", np.nan)
    .astype(float)
    .astype(int)
)

#drop rows with missing values
df = df.dropna(subset=["reaction_time_ms", "actual_age"])

#prepare data
X = df[["participant_gender", "reaction_time_ms"]]
y = df["actual_age"]

preprocessor = ColumnTransformer(
    transformers=[
        ("gender_encoder", OneHotEncoder(categories=[["M","F"]], drop='first'), ["participant_gender"]),
        ("reaction_scaler", StandardScaler(), ["reaction_time_ms"])
    ]
)

# SVR Pipeline (RBF kernel)
model = Pipeline([
    ("preprocessor", preprocessor),
    ("regressor", SVR(kernel="rbf", C=10, epsilon=6))
])

#Train the Model

X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)
model.fit(X_train, y_train)

print("Model training complete.")
print("Model test score (RÂ²):", model.score(X_test, y_test))

#Prediction Function

def predict_age(gender, reaction_time):
    input_data = pd.DataFrame([[gender, reaction_time]], columns=["participant_gender", "reaction_time_ms"])
    predicted_age = model.predict(input_data)[0]
    return predicted_age

# Example prediction
example_gender = "F"
example_reaction_time = 253.4
predicted = predict_age(example_gender, example_reaction_time)
print(f"Predicted Age for {example_gender} with {example_reaction_time} ms reaction time = {predicted:.2f} years")
